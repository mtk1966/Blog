@using Blog.Mcv
@using Blog.Data
@inject BlogDbContext DbContext
@model DetailsViewModel

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>Blog Details
            </h3>
        </div>
        <div class="card-body bgblack white">
            <dl class="row">
                <dt class="col-sm-3">Blog Owner</dt>
                <dd class="col-sm-9">@Model.Blog.User.UserName</dd>

                <dt class="col-sm-3">Creation Date</dt>
                <dd class="col-sm-9">@Model.Blog.CreatedAt.ToString("dd MMMM yyyy HH:mm")</dd>

                <dt class="col-sm-3">Title</dt>
                <dd class="col-sm-9">@Model.Blog.Title</dd>

                <dt class="col-sm-3">Content</dt>
                <dd class="col-sm-9">@Html.Raw(Model.Blog.Content)</dd>
            </dl>
        </div>
        <div class="card-footer bgblack">
            <a asp-controller="Home" asp-action="Index" class="btn btn-primary">Back to Index</a>
            @if (User.HasPermission("Blogs.Edit", DbContext))
            {
                <a asp-controller="Home" asp-action="Edit" asp-route-id="@Model.Blog.Id" class="btn btn-warning">Edit</a>
            }
            @if (User.HasPermission("Blogs.Delete", DbContext))
            {
                <a asp-controller="Home" asp-action="DeleteBlogMod" asp-route-id="@Model.Blog.Id" class="btn btn-danger">Delete</a>
            }
        </div>
    </div>

    <div class="mt-4">
        <h4>Comments</h4>
        <hr />

        <div class="mt-3">
            @if (User.HasPermission("Comments.Create", DbContext))
            {
                <form asp-controller="Home" asp-action="AddComment" method="post">
                    <input type="hidden" name="blogId" value="@Model.Blog.Id" />
                    <div class="form-group">
                        <textarea name="content" class="form-control" rows="3" placeholder="Add a comment..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mt-2">Submit</button>
                </form>
            }
        </div>

        <div class="mt-4">
            @foreach (var comment in Model.Comments)
            {
                <div class="card mb-2">
                    <div class="card-body">
                        <p class="card-text">@comment.Content</p>
                        <p class="card-text"><small class="text-muted">By @comment.UserName on @comment.CreatedAt.ToString("dd MMMM yyyy HH:mm")</small></p>
                        @if (User.IsInRole("admin") || User.IsInRole("mod") || User.Claims.FirstOrDefault(c => c.Type == System.IdentityModel.Tokens.Jwt.JwtRegisteredClaimNames.Sub)?.Value == comment.UserId.ToString())
                        {
                            <a asp-controller="Home" asp-action="EditComment" asp-route-id="@comment.Id" class="btn btn-warning btn-sm">Edit</a>
                            <form asp-controller="Home" asp-action="DeleteComment" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                <input type="hidden" name="commentId" value="@comment.Id" />
                                <input type="hidden" name="blogId" value="@Model.Blog.Id" />
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>